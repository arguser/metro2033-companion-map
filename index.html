<!DOCTYPE html>
<html ng-app="app">

<head>
  <!-- Metadata -->
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1" name="viewport">

  <!-- Title & favicon -->
  <title>Metro 2033 Companion Map</title>
  <link href="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Moscow_Metro.svg/125px-Moscow_Metro.svg.png" rel="icon">

  <!-- Angular Material -->
  <link href="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.4/angular-material.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700,300" rel="stylesheet">

  <!-- App styles -->
  <link href="assets/css/app.css" rel="stylesheet">
</head>

<body onload="drawMap()">
  <div ng-controller="MapController as map" layout="column">
    <div id="toolbar" layout="column" flex="20" ng-class="{'sarasa': !map.toggle}">
      <md-content layout="row">
        <form ng-submit="$event.preventDefault()" class="form-search" ng-show="map.toggled">
          <md-autocomplete id="omnibox" md-floating-label="Station" md-item-text="item.display.station_name" md-items="item in map.querySearch(map.searchText)" md-min-length="0" md-no-cache="map.noCache" md-search-text-change="map.searchTextChange(map.searchText)"
          md-search-text="map.searchText" md-selected-item-change="map.selectedItemChange(item)" md-selected-item="map.selectedItem" ng-disabled="map.isDisabled" role="listbox">
            <md-item-template>
              <span md-highlight-flags="^i" md-highlight-text="map.searchText">{{item.display.station_name}}</span>
            </md-item-template>
            <md-not-found>
              No station matching "{{map.searchText}}" were found.
            </md-not-found>
          </md-autocomplete>
        </form>
      </md-content>
      <div class="panel-toggle-button" ng-click="map.togglePanel()" ng-class="{'panel-toggle-button-hidden': !map.toggle}" ng-show="map.station != null"></div>
      <div class="panel" ng-show="map.station != null && map.toggle" layout="column" data-ng-animate="{enter: 'ng-enter'}" flex="100">
        <station-image flex="35"></station-image>
        <station-name></station-name>
        <md-tabs class="md-accent" md-selected="self.selectedIndex" layout="column" flex="100" md-stretch-tabs="auto">
          <md-tab id="station-tab" ng-disabled="map.station.station_description == ''">
            <md-tab-label>Description</md-tab-label>
            <md-tab-body>
              <station-description></station-description>
            </md-tab-body>
          </md-tab>
          <md-tab id="faction-tab" ng-disabled="map.faction == false">
            <md-tab-label>Faction</md-tab-label>
            <md-tab-body>
              <faction-description></faction-description>
            </md-tab-body>
          </md-tab>
        </md-tabs>
      </div>
    </div>
    <div id="canvasHolder" flex="80">
      <canvas id="lineCanvas" class="metromap" width="1800" height="2000"></canvas>
      <canvas id="stationCanvas" class="metromap" width="1800" height="2000"></canvas>
      <canvas id="labelCanvas" class="metromap" width="1800" height="2000"></canvas>
      <canvas id="effectCanvas" class="metromap" width="1800" height="2000"></canvas>
      <a class="station_link" ng-repeat="station in map.stations" ng-click="map.highlight_stations(station)" style="top: {{(1.5 * station.display.y_position) - ((7+1)*1.5)}}px; left: {{(1.5 * station.display.x_position) - ((7+1)*1.5)}}px;">
      </a>
    </div>
  </div>
  <!-- <div class="map" layout="row" flex="80">
        <canvas id="map">
          <img alt="Metro 2033 Map" class="map" id="metro" src="http://media.moddb.com/images/games/1/13/12559/metro_guide_eng.gif">
        </canvas>
      </div> -->

  <footer>
    Tool
    <a href="https://github.com/arguser/metro2033-companion-map">coded</a> with love by
    <a href="https://twitter.com/arguser">arguser</a>,
    <a href="https://github.com/MightyGoatMan">MightyGoatMan</a> and
    <a href="https://github.com/cristiands7">cristiands7</a>
  </footer>

  <!-- Angular -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-animate.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-aria.min.js"></script>
  <!-- Angular Material -->
  <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.4/angular-material.min.js"></script>

  <!-- Module definition -->
  <script src="app/app.module.js"></script>
  <!-- Configurations -->
  <script src="app/app.config.js"></script>
  <!-- Data -->
  <script src="assets/data/locations.js"></script>
  <!-- Controllers -->
  <script src="app/controllers/MapController.js"></script>
  <!-- Directives -->
  <script src="app/directives/MapDirectives.js"></script>
  <!-- Services -->
  <script src="app/services/FactionService.js"></script>
  <script src="app/services/LineService.js"></script>
  <script src="app/services/StationService.js"></script>
  <script type="text/javascript" src="assets/js/utilities.js"></script>
  <script type="text/javascript" src="assets/js/symbols.js"></script>
  <!-- <script type="text/javascript" src="assets/js/stations.js"></script> -->

  <script type="text/javascript">
    var animHolder;
    var animCurrentFrame;
    var animFrames;

    var ctx = []; // holder for canvases
    var data_version = 3; // what data sets to use
    var name_set = 0; // what name set to use

    function drawMap() {

      // get canvas objects
      var canvas1 = document.getElementById('lineCanvas');
      ctx1 = canvas1.getContext('2d');
      var canvas2 = document.getElementById('stationCanvas');
      ctx2 = canvas2.getContext('2d');
      var canvas3 = document.getElementById('labelCanvas');
      ctx3 = canvas3.getContext('2d');
      var canvas4 = document.getElementById('effectCanvas');
      ctx4 = canvas4.getContext('2d');

      // put them in array
      ctx = [ctx1, ctx2, ctx3, ctx4];

      // initialise canvases
      for (i = 0; i < ctx.length; i++) {
        ctx[i].clearRect(0, 0, 1800, 2000);
        ctx[i].scale(1, 1);
        ctx[i].lineCap = 'round';
        ctx[i].textBaseline = 'middle'
      }

      // draw rail lines
      for (i = 0; i < lines.length; i++) {
        thisLine = lines[i];
        drawLine(thisLine);
      }

      // draw interchanges
      interchange_2(705, 368, 683, 385); // Prospect Mir
      interchange_2(521, 823, 499, 846); // October
      interchange_2(683, 472, 698, 489); // Chistye Prudy
      interchange_2(412, 778, 388, 778); // Park Kultry
      interchange_2(762, 425, 762, 450); // Komsomol
      interchange_3(800,588, 800,620, 820,604); // Kursk
      interchange_2(708,662, 683,662); // Kitay Gorod
      interchange_2(390,410, 390,435); // Belarus
      interchange_2(890,766, 870,745); // Rimskaya
      interchange_2(490,350, 490,372); // Novoslobodskaya
      interchange_3(800,766, 800,740, 775,751); // Taganskaya
      interchange_2(870,810, 847,810); // Proletariat
      interchange_2(578,1030, 602,1030); // Sebastapol
      interchange_2(411,1150, 435,1150); // Bittsevsky Park
      interchange_2(584,1210, 608,1210); // Bulvar Dmitriya Donskogo
      interchange_2(590,855, 608,875); // Dobryninskaya
      interchange_4(542,648, 510,660, 485,636, 525,617); // Polis
  
      // draw stations
      for (i = 0; i < stations.length; i++) {
        ctx[2].clearRect(0, 0, 1800, 2000);
        thisStation = stations[i];
        station(thisStation['x_position'], thisStation['y_position'], thisStation['faction_id'], thisStation['symbol_id']);

        // create HTML Object for station
        // clickable_station(thisStation['x_position'], thisStation['y_position'], thisStation['station_id']);
      }


      // label stations
      draw_features();

      // label stations
      print_station_labels();

    }
  </script>
</body>

</html>
